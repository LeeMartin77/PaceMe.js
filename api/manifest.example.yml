apiVersion: v1
kind: Service
metadata:
  name: paceme-api
  namespace: paceme-api
  labels:
    app: paceme-api
spec:
  ports:
  - name: http
    port: 8081
    protocol: TCP
    targetPort: 8080
  selector:
    app: paceme-api
  type: ClusterIP
---
apiVersion: v1
kind: Pod
metadata:
  name: paceme-api
  namespace: paceme-api
  labels:
    app: paceme-api
spec:
  containers:
    - name: paceme-api
      image: <aws-account-id>.dkr.ecr.<aws-region>.amazonaws.com/<image-name>:<tag>
      imagePullPolicy: Always
      ports:
        - name: web
          containerPort: 8080
      env:
        - name: AWS_REGION
          value: eu-west-2
        - name: AWS_ACCESS_KEY_ID
          value: ACCESSKEYID
        - name: AWS_SECRET_ACCESS_KEY
          value: SECRETKEY
        - name: COGNITO_USER_POOL_ID
          value: USERPOOLID
        - name: TRAINING_PLAN_TABLE
          value: TrainingPlan
        - name: TRAINING_PLAN_ACTIVITY_TABLE
          value: TrainingPlanActivity
  imagePullSecrets:
      - name: awsregcred
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: paceme-api-ingress
  namespace: paceme-api
spec:
  rules:
    - host: api-dev.paceme.info
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name:  paceme-api
                port:
                  number: 8081
  # tls:
  #   - hosts:
  #     - api-dev.paceme.info
  #     secretName: paceme-api-dev-certificate
# ---
# apiVersion: cert-manager.io/v1
# kind: Certificate
# metadata:
#   name: paceme-api-dev-cert
#   namespace: paceme-api
# spec:
#   secretName: paceme-api-dev-certificate
#   issuerRef:
#     name: letsencrypt-prod
#   dnsNames:
#   - api-dev.paceme.info
# ---
# apiVersion: cert-manager.io/v1
# kind: Issuer
# metadata:
#   name: letsencrypt-prod
#   namespace: paceme-api
# spec:
#   acme:
#     server: https://acme-v02.api.letsencrypt.org/directory
#     email: hello@leejohnmartin.co.uk
#     privateKeySecretRef:
#       name: account-key-prod
#     solvers:
#     - http01:
#        ingress:
#          #class: nginx
#          name: paceme-api-ingress
      # - selector:
      #     dnsZones:
      #       - "paceme.info"
      
#         dns01:
#           route53:
#             region: eu-west-2
#             accessKeyID: SECRETID
#             secretAccessKeySecretRef: 
#               name: prod-route53-credentials-secret
#               key: secret-access-key
# ---
# apiVersion: v1
# kind: Secret
# metadata:
#   name: prod-route53-credentials-secret
#   namespace: paceme-api
# type: Opaque
# data:
#   secret-access-key: SECRETKEY
